name: Deploy Node.js to AWS EC2

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # Check out the code
      - name: Checkout code
        uses: actions/checkout@v4

      # Deploy to EC2
      - name: Deploy to EC2
        env:
          EC2_HOST: ${{ secrets.EC2_HOST }}
          EC2_USER: ${{ secrets.EC2_USER }}
          EC2_SSH_KEY: ${{ secrets.EC2_SSH_KEY }}
          APP_PATH: ${{ secrets.APP_PATH }}
        run: |
          # Create SSH key file
          mkdir -p ~/.ssh
          echo "$EC2_SSH_KEY" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          
          # Add EC2 host to known_hosts to avoid SSH prompts
          ssh-keyscan -H $EC2_HOST >> ~/.ssh/known_hosts 2>/dev/null
          
          # SSH into EC2 and deploy
          ssh -o StrictHostKeyChecking=no -i ~/.ssh/deploy_key $EC2_USER@$EC2_HOST << 'ENDSSH'
            set -e
            
            echo "=== Navigating to app directory ==="
            cd ${APP_PATH}
            
            echo "=== Current directory: $(pwd) ==="
            
            echo "=== Pulling latest changes ==="
            git pull origin main
            
            echo "=== Installing dependencies ==="
            npm install
            
            echo "=== Restarting application with PM2 ==="
            pm2 restart all
            
            echo "=== PM2 Status ==="
            pm2 status
            
            echo "=== Deployment completed successfully ==="
          ENDSSH